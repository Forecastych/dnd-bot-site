<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü–µ—Ä—Å–æ–Ω–∞–∂ Dark Fantasy DnD</title>
  <style>
    body {
      background-color: #1a1a1a;
      color: #ddd;
      font-family: "Cormorant Garamond", serif, "Times New Roman", serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    h1, h2, h3 {
      font-family: "Cinzel", serif;
      color: #b34e2d;
      margin-bottom: 5px;
    }
    .section {
      border: 1px solid #4b2e1e;
      padding: 15px;
      margin-bottom: 20px;
      background: #2a211a;
      border-radius: 6px;
    }
    .flex-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    .attribute, .stat {
      background: #3b2f25;
      padding: 10px 15px;
      border-radius: 4px;
      flex: 1 1 120px;
      min-width: 120px;
      text-align: center;
    }
    .label {
      font-weight: 700;
      font-size: 0.9em;
      margin-bottom: 5px;
      color: #d47b4a;
    }
    [contenteditable]:focus {
      outline: 2px solid #d47b4a;
      background: #443827;
    }
    ul {
      list-style-type: none;
      padding-left: 0;
    }
    li {
      background: #3b2f25;
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 4px;
    }
    .move-title {
      font-weight: 700;
      color: #bb6a42;
    }
    .move-text {
      margin-top: 4px;
      font-size: 0.9em;
      color: #c9ad8e;
    }
    button {
      background: #b34e2d;
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 700;
      margin: 5px 5px 0 0;
    }
    button:hover {
      background: #d26a3b;
    }
    .icon {
      font-size: 1.2em;
      margin-right: 5px;
    }
    .modifier {
      margin-top: 5px;
      font-size: 0.85em;
      color: #a8896d;
    }
  </style>
</head>
<body>

<h1 contenteditable="true" id="character-name">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h1>

<div class="section">
  <h2>–í–Ω–µ—à–Ω–æ—Å—Ç—å</h2>
  <p contenteditable="true" id="appearance" style="min-height: 60px;">–û–ø–∏—à–∏ –≤–Ω–µ—à–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞...</p>
</div>

<div class="section">
  <h2>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h2>
  <div class="flex-row">
    <div class="attribute">
      <div class="label">–°–∏–ª–∞</div>
      <div contenteditable="true" oninput="updateModifiers()" id="str">10</div>
      <div class="modifier" id="mod-str">–ë–æ–Ω—É—Å –∫ –±—Ä–æ—Å–∫—É: +0</div>
    </div>
    <div class="attribute">
      <div class="label">–õ–æ–≤–∫–æ—Å—Ç—å</div>
      <div contenteditable="true" oninput="updateModifiers()" id="dex">10</div>
      <div class="modifier" id="mod-dex">–ë–æ–Ω—É—Å –∫ –±—Ä–æ—Å–∫—É: +0</div>
    </div>
  </div>
  <div class="flex-row">
    <div class="attribute">
      <div class="label">–¢–µ–ª–æ—Å–ª–æ–∂–µ–Ω–∏–µ</div>
      <div contenteditable="true" oninput="updateModifiers()" id="con">10</div>
      <div class="modifier" id="mod-con">–ë–æ–Ω—É—Å –∫ –±—Ä–æ—Å–∫—É: +0</div>
    </div>
    <div class="attribute">
      <div class="label">–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç</div>
      <div contenteditable="true" oninput="updateModifiers()" id="int">10</div>
      <div class="modifier" id="mod-int">–ë–æ–Ω—É—Å –∫ –±—Ä–æ—Å–∫—É: +0</div>
    </div>
  </div>
  <div class="flex-row">
    <div class="attribute">
      <div class="label">–ú—É–¥—Ä–æ—Å—Ç—å</div>
      <div contenteditable="true" oninput="updateModifiers()" id="wis">10</div>
      <div class="modifier" id="mod-wis">–ë–æ–Ω—É—Å –∫ –±—Ä–æ—Å–∫—É: +0</div>
    </div>
    <div class="attribute">
      <div class="label">–•–∞—Ä–∏–∑–º–∞</div>
      <div contenteditable="true" oninput="updateModifiers()" id="cha">10</div>
      <div class="modifier" id="mod-cha">–ë–æ–Ω—É—Å –∫ –±—Ä–æ—Å–∫—É: +0</div>
    </div>
  </div>
</div>


<div class="section flex-row">
  <div class="stat">
    <div class="label"><span class="icon">üé≤</span>–£—Ä–æ–Ω</div>
    <div contenteditable="true" id="damage">1d6</div>
  </div>
  <div class="stat">
    <div class="label"><span class="icon">üõ°Ô∏è</span>–ë—Ä–æ–Ω—è</div>
    <div contenteditable="true" id="armor">12</div>
  </div>
  <div class="stat">
    <div class="label"><span class="icon">‚ù§Ô∏è</span>–û–±—â–µ–µ –∑–¥–æ—Ä–æ–≤—å–µ</div>
    <div contenteditable="true" id="hp">30</div>
  </div>
</div>

<div class="section flex-row">
  <div class="stat" style="flex: 2 1 300px;">
    <div class="label">–ú–∏—Ä–æ–≤–æ–∑–∑—Ä–µ–Ω–∏–µ</div>
    <div contenteditable="true" id="alignment">–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –∑–ª–æ–µ</div>
  </div>
  <div class="stat">
    <div class="label">–†–∞—Å–∞</div>
    <div contenteditable="true" id="race">–ß–µ–ª–æ–≤–µ–∫</div>
  </div>
  <div class="stat" style="flex: 2 1 300px;">
    <div class="label">–£–∑—ã</div>
    <div contenteditable="true" id="bonds">–°–≤—è–∑—å —Å —Ç–µ–Ω—è–º–∏</div>
  </div>
</div>

<div class="section">
  <h2>–°—Ç–∞—Ä—Ç–æ–≤—ã–µ —Ö–æ–¥—ã</h2>
  <ul id="moves-list">
    <li>
      <div class="move-title" contenteditable="true">–¢–µ–º–Ω–æ–µ –ø—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–∏–µ</div>
      <div class="move-text" contenteditable="true">–¢–≤–æ–∏ –∞—Ç–∞–∫–∏ –Ω–∞–Ω–æ—Å—è—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —É—Ä–æ–Ω —Ç—å–º–æ–π.</div>
    </li>
  </ul>
  <button id="add-move-btn">–î–æ–±–∞–≤–∏—Ç—å —Ö–æ–¥</button>
</div>

<div class="section flex-row">
  <div class="stat" style="flex: 1 1 150px;">
    <div class="label">–ö–ª–∞—Å—Å</div>
    <div contenteditable="true" id="class">–í–∞—Ä–≤–∞—Ä</div>
  </div>
  <div class="stat" style="flex: 1 1 150px;">
    <div class="label">–£—Ä–æ–≤–µ–Ω—å</div>
    <div contenteditable="true" id="level">1</div>
  </div>
  <div class="stat" style="flex: 1 1 150px;">
    <div class="label">–û–ø—ã—Ç</div>
    <div contenteditable="true" id="xp">0</div>
  </div>
</div>

<div class="section">
  <h2>–°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ</h2>
  <p contenteditable="true" id="gear" style="min-height: 60px;">–ö–∏–Ω–∂–∞–ª, –ú–∞–Ω—Ç–∏—è –∏–∑ —Ç–µ–Ω–µ–π, –§–ª—è–≥–∞ —Å —è–¥–æ–º</p>
</div>

<div class="section">
  <h2>–†–∞—Å–æ–≤–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å</h2>
  <p contenteditable="true" id="racial-ability" style="min-height: 40px;">–¢–µ–º–Ω–æ–µ –∑—Ä–µ–Ω–∏–µ</p>
</div>

<div class="section">
  <h2>–ü—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—è</h2>
  <p contenteditable="true" id="backstory" style="min-height: 80px;">–†–∞—Å—Å–∫–∞–∑ –æ –º—Ä–∞—á–Ω–æ–º –ø—Ä–æ—à–ª–æ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞...</p>
</div>

<div class="section">
  <button onclick="saveToFile()">üì• –°–∫–∞—á–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
  <button onclick="loadFromFile()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
  <button onclick="sendToBot()" id="send-to-bot-btn">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –±–æ—Ç–∞</button>
  <button onclick="loadFromBot()" id="load-from-bot-btn">üì° –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –±–æ—Ç–∞</button>
</div>

<script>
 function getModifier(value) {
  value = parseInt(value);
  if (isNaN(value)) return 0;
  if (value < 9) return -1;
  if (value <= 12) return 0;
  if (value <= 15) return 1;
  if (value <= 19) return 2;
  if (value >= 20) return 3;
  return 0;
}

function updateModifiers() {
  const ids = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
  ids.forEach(id => {
    let val = parseInt(document.getElementById(id).innerText);
    if (isNaN(val)) val = 10;
    const mod = getModifier(val);
    const modEl = document.getElementById('mod-' + id);
    modEl.innerText = '–ë–æ–Ω—É—Å –∫ –±—Ä–æ—Å–∫—É: ' + (mod >= 0 ? '+' : '') + mod;
    if (mod < 0) {
      modEl.style.color = '#e06c75'; // –∫—Ä–∞—Å–Ω—ã–π
    } else if (mod === 0) {
      modEl.style.color = '#aaa'; // —Å–µ—Ä—ã–π
    } else {
      modEl.style.color = '#98c379'; // –∑–µ–ª—ë–Ω—ã–π
    }
  });
}

function getContent() {
  return {
    name: document.getElementById('character-name').textContent,
    appearance: document.getElementById('appearance').textContent,
    damage: document.getElementById('damage').textContent,
    armor: document.getElementById('armor').textContent,
    hp: document.getElementById('hp').textContent,
    alignment: document.getElementById('alignment').textContent,
    race: document.getElementById('race').textContent,
    bonds: document.getElementById('bonds').textContent,
    gear: document.getElementById('gear').textContent,
    class: document.getElementById('class').textContent,
    level: document.getElementById('level').textContent,
    xp: document.getElementById('xp').textContent,
    racialAbility: document.getElementById('racial-ability').textContent,
    backstory: document.getElementById('backstory').textContent,
    attributes: ['str','dex','con','int','wis','cha'].map(id => ({
      name: document.querySelector(`[for="${id}"]`)?.textContent || id,
      value: document.getElementById(id).textContent
    })),
    moves: [...document.querySelectorAll('#moves-list li')].map(li => ({
      title: li.querySelector('.move-title').textContent,
      text: li.querySelector('.move-text').textContent
    }))
  };
}



function saveToFile() {
  const blob = new Blob([JSON.stringify(getContent(), null, 2)], { type: 'application/json' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'character.json';
  link.click();
}

function loadFromFile() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      const data = JSON.parse(reader.result);
      if (data.name) document.getElementById('character-name').textContent = data.name;
      document.getElementById('appearance').textContent = data.appearance || '';
      document.getElementById('damage').textContent = data.damage || '';
      document.getElementById('armor').textContent = data.armor || '';
      document.getElementById('hp').textContent = data.hp || '';
      document.getElementById('alignment').textContent = data.alignment || '';
      document.getElementById('race').textContent = data.race || '';
      document.getElementById('bonds').textContent = data.bonds || '';
      document.getElementById('gear').textContent = data.gear || '';
      document.getElementById('class').textContent = data.class || '';
      document.getElementById('level').textContent = data.level || '';
      document.getElementById('xp').textContent = data.xp || '';
      document.getElementById('racial-ability').textContent = data.racialAbility || '';
      document.getElementById('backstory').textContent = data.backstory || '';
      ['str','dex','con','int','wis','cha'].forEach((id, i) => {
        if(data.attributes && data.attributes[i]) {
          document.getElementById(id).textContent = data.attributes[i].value;
        }
      });
      updateModifiers();
      const movesList = document.getElementById('moves-list');
      movesList.innerHTML = '';
      if (data.moves && data.moves.length) {
        data.moves.forEach(move => {
          const li = document.createElement('li');
          li.innerHTML = `
            <div class="move-title" contenteditable="true">${move.title}</div>
            <div class="move-text" contenteditable="true">${move.text}</div>
          `;
          movesList.appendChild(li);
        });
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

window.addEventListener('load', () => {
  updateModifiers();
});
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–æ—Ä–º—ã –≤ localStorage
function autosave() {
  const data = {};

  document.querySelectorAll('[contenteditable="true"]').forEach(el => {
    if (el.id) {
      data[el.id] = el.innerText;
    }
  });
  const notif = document.getElementById('save-notification');
  notif.style.opacity = 1;
  setTimeout(() => notif.style.opacity = 0, 1500);

  localStorage.setItem('autosaveData', JSON.stringify(data));
  console.log('–î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
}

const TELEGRAM_USER_ID = '529193051'; // –ø–æ–º–µ–Ω—è–π –Ω–∞ —Å–≤–æ–π ID

// –ê–¥—Ä–µ—Å backend —Å–µ—Ä–≤–µ—Ä–∞ (–≥–¥–µ –∑–∞–ø—É—â–µ–Ω –±–æ—Ç –∏–ª–∏ –ø—Ä–æ–∫—Å–∏ API)
const BACKEND_URL = 'https://dndbot-ejj9.onrender.com';

async function saveCharacter(userId, characterName, characterData) {
  const response = await fetch("https://dndbot-ejj9.onrender.com/save_character", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      user_id: userId,
      character_name: characterName,
      character: characterData
    })
  });
  const result = await response.json();
  console.log(result.message);
}

async function loadCharacter(userId, characterName) {
  try {
    const response = await fetch(`https://dndbot-ejj9.onrender.com/load_character?user_id=${userId}&character_name=${encodeURIComponent(characterName)}`);
    if (!response.ok) throw new Error("Character not found");
    const data = await response.json();
    console.log(data.character);
    return data.character;
  } catch (e) {
    console.error(e);
  }
}

// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–±–æ—Ç—É)
async function sendToBot() {
  const data = getContent();
  try {
    const response = await fetch(`${BACKEND_URL}/save_character`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        user_id: parseInt(TELEGRAM_USER_ID), 
        character_name: data.name,           
        character: data
      })
    });

    if (response.ok) {
      localStorage.setItem("lastCharacterName", data.name);
      alert('–ü–µ—Ä—Å–æ–Ω–∞–∂ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç—É —É—Å–ø–µ—à–Ω–æ!');
    } else {
      const error = await response.json();
      alert(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: ${error.detail}`);
      console.error(error);
    }
  } catch (e) {
    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞.');
    console.error(e);
  }
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞ (–±–æ—Ç–∞)
async function loadFromBot() {
  try {
  const characterName = localStorage.getItem("lastCharacterName") || prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:");

    const response = await fetch(`${BACKEND_URL}/load_character?user_id=${TELEGRAM_USER_ID}&character_name=${encodeURIComponent(characterName)}`);
    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');

    const result = await response.json();
    const data = result.character;
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –∏–∑ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ JSON
    if (data) {
      if (data.name) document.getElementById('character-name').textContent = data.name;
      document.getElementById('appearance').textContent = data.appearance || '';
      document.getElementById('damage').textContent = data.damage || '';
      document.getElementById('armor').textContent = data.armor || '';
      document.getElementById('hp').textContent = data.hp || '';
      document.getElementById('alignment').textContent = data.alignment || '';
      document.getElementById('race').textContent = data.race || '';
      document.getElementById('bonds').textContent = data.bonds || '';
      document.getElementById('gear').textContent = data.gear || '';
      document.getElementById('class').textContent = data.class || '';
      document.getElementById('level').textContent = data.level || '';
      document.getElementById('xp').textContent = data.xp || '';
      document.getElementById('racial-ability').textContent = data.racialAbility || '';
      document.getElementById('backstory').textContent = data.backstory || '';
      ['str','dex','con','int','wis','cha'].forEach((id, i) => {
        if(data.attributes && data.attributes[i]) {
          document.getElementById(id).textContent = data.attributes[i].value;
        }
      });
      updateModifiers();
      const movesList = document.getElementById('moves-list');
      movesList.innerHTML = '';
      if (data.moves && data.moves.length) {
        data.moves.forEach(move => {
          const li = document.createElement('li');
          li.innerHTML = `
            <div class="move-title" contenteditable="true">${move.title}</div>
            <div class="move-text" contenteditable="true">${move.text}</div>
          `;
          movesList.appendChild(li);
        });
      }
      alert('–ü–µ—Ä—Å–æ–Ω–∞–∂ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –±–æ—Ç–∞!');
    }
  } catch (e) {
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏–∑ –±–æ—Ç–∞.');
    console.error(e);
  }
}


// –ó–∞–≥—Ä—É–∂–∞–µ–º contenteditable –¥–∞–Ω–Ω—ã–µ
function autoload() {
  const savedData = localStorage.getItem('autosaveData');
  if (!savedData) return;

  const data = JSON.parse(savedData);
  Object.entries(data).forEach(([key, value]) => {
    const el = document.getElementById(key);
    if (el && el.hasAttribute('contenteditable')) {
      el.innerText = value;
    }
  });

  updateModifiers(); // –æ–±–Ω–æ–≤–ª—è–µ–º –±–æ–Ω—É—Å—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
  console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
}

window.addEventListener('DOMContentLoaded', () => {
  autoload();

  document.querySelectorAll('[contenteditable="true"]').forEach(el => {
    el.addEventListener('input', autosave);
  });
});
document.getElementById('add-move-btn').addEventListener('click', () => {
  const movesList = document.getElementById('moves-list');
  const li = document.createElement('li');
  li.innerHTML = `
    <div class="move-title" contenteditable="true">–ù–æ–≤—ã–π —Ö–æ–¥</div>
    <div class="move-text" contenteditable="true">–û–ø–∏—Å–∞–Ω–∏–µ —Ö–æ–¥–∞...</div>
  `;
  movesList.appendChild(li);
});

</script>

<div id="save-notification" style="
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: #b34e2dcc;
  color: white;
  padding: 6px 12px;
  border-radius: 4px;
  font-size: 0.9em;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.5s ease;
  z-index: 9999;
">
  –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ
</div>

</body>
</html>
