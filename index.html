<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π favicon -->
  <link rel="icon" type="image/png" href="site_icon.png">

  <!-- Apple —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ -->
  <link rel="apple-touch-icon" href="site_icon.png">

  <!-- Microsoft –ø–ª–∏—Ç–∫–∏ -->
  <meta name="msapplication-TileImage" content="site_icon.png">
  <title>–ü–µ—Ä—Å–æ–Ω–∞–∂ Dark Fantasy DnD</title>
  <style>
    @font-face {
      font-family: 'Foxcroft NF';
      src: url('./fonts/FoxcroftNF.otf') format('opentype');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
}
    body {
  background-image: url('background.jpg');
  background-size: cover;
  background-position: center center;
  background-repeat: no-repeat;
  background-color: #1a1a1a;
  color: #ddd;
  font-family: 'Foxcroft NF', serif;
  padding: 20px;
  max-width: 900px;
  margin: auto;
  line-height: 1.6;
}

body, input, textarea, select, button, [contenteditable], p, span, div {
  font-family: 'Foxcroft NF', serif !important;
}

h1, h2, h3 {
  font-family: 'Foxcroft NF', serif;
  color: #b34e2d;
  text-shadow: 1px 1px 2px #000;
  margin-bottom: 8px;
  letter-spacing: 1px;
}

/* –ö–Ω–æ–ø–∫–∞ –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É */
    #dice-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: url('https://www.pngall.com/wp-content/uploads/15/DND-Dice-PNG-Photos.png') no-repeat center/contain;
      cursor: pointer;
      border-radius: 50%;
      box-shadow: 0 0 10px #d47b4a;
      transition: box-shadow 0.3s;
      z-index: 10000;
      background-color: #4b2e1e;
    }
    .dice-button:hover {
      box-shadow: 0 0 20px #d47b4a;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    #dice-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(20, 10, 5, 0.95);
      display: none; /* —Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    #dice-modal-content {
      background: #2a211a;
      padding: 20px;
      border-radius: 10px;
      color: #f2e0c9;
      width: 90%;
      max-width: 400px;
      text-align: center;
      position: relative;
    }

    /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è */
    #close-modal {
      position: absolute;
      top: 10px; right: 10px;
      background: transparent;
      border: none;
      font-size: 24px;
      color: #d47b4a;
      cursor: pointer;
      font-weight: bold;
    }

    .dice-option {
      display: inline-block;
      background: #4b2e1e;
      color: #f2e0c9;
      padding: 10px 14px;
      margin: 5px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
      user-select: none;
    }

    .dice-option:hover {
      background: #6a3a25;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –∫—É–±–∏–∫–∞ */
    #dice-animation {
      width: 100px;
      height: 100px;
      margin: 20px auto;
      animation: spin 2s linear infinite;
      background-image: url('https://media.tenor.com/KBNPB0oVi_oAAAAj/nat19-natural19.gif');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    #dice-result {
      font-size: 1.4em;
      margin-top: 15px;
      color: #d47b4a;
      font-weight: bold;
      min-height: 30px;
    }

    #dice-history {
      margin-top: 20px;
      text-align: left;
      max-height: 130px;
      overflow-y: auto;
      background: #3b2f25;
      padding: 10px;
      border-radius: 6px;
      font-size: 0.95em;
      user-select: text;
    }

    #dice-history div {
      margin-bottom: 5px;
    }

.section {
  position: relative;
  padding: 30px 18px; /* –º–µ—Å—Ç–æ –ø–æ–¥ —Ä–∞–º–∫—É –∏ —Ç–µ–∫—Å—Ç */
  margin-bottom: 25px;
  background: linear-gradient(145deg, #2a211a, #1d1712);
  border-radius: 8px;
  box-shadow: 0 0 10px #00000055;
  color: #ddd;
  z-index: 1;
  overflow: visible;
}

/* –†–∞–º–∫–∞ */
.section::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  border-radius: 8px;
  background: url('frame.png') no-repeat center center;
  background-size: 100% 100%;
  z-index: 1;
  pointer-events: none;
  filter: brightness(0.6); /* –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ä–∞–º–∫–∏ */
}

/* –¢–µ–∫—Å—Ç –ø–æ–≤–µ—Ä—Ö –≤—Å–µ—Ö —Å–ª–æ—ë–≤ */
.section > * {
  position: relative;
  z-index: 3;
}
.flex-row {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
}

.attribute, .stat {
  background: #3b2f25;
  padding: 12px 18px;
  border-radius: 6px;
  flex: 1 1 120px;
  min-width: 120px;
  text-align: center;
  box-shadow: inset 0 0 4px #00000066;
}

.label {
  font-weight: 700;
  font-size: 0.9em;
  margin-bottom: 5px;
  color: #d47b4a;
  text-shadow: 0 0 2px #000;
}

[contenteditable]:focus {
  outline: 2px solid #d47b4a;
  background: #443827;
  box-shadow: 0 0 6px #b34e2d;
}

ul {
  list-style-type: none;
  padding-left: 0;
  margin: 0;
}

li {
  background: #3b2f25;
  margin-bottom: 10px;
  padding: 8px 12px;
  border-radius: 4px;
  box-shadow: inset 0 0 2px #000000aa;
}

.move-title {
  font-weight: 700;
  color: #bb6a42;
  text-shadow: 0 0 2px #000;
}

.move-text {
  margin-top: 4px;
  font-size: 0.9em;
  color: #c9ad8e;
}

button {
  background: #b34e2d;
  border: none;
  color: #fff;
  padding: 10px 14px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 700;
  box-shadow: 0 2px 6px #00000066;
  transition: background 0.2s ease;
  font-family: 'Foxcroft NF', serif;
}

button:hover {
  background: #d26a3b;
}

.icon {
  font-size: 1.2em;
  margin-right: 5px;
}

.modifier {
  margin-top: 5px;
  font-size: 0.85em;
  color: #a8896d;
}

  </style>
</head>
<body>

<h1 contenteditable="true" id="character-name">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h1>

<!-- –ö–Ω–æ–ø–∫–∞ –≤—ã–∑–æ–≤–∞ -->
<div id="dice-button" title="–ë—Ä–æ—Å–∏—Ç—å –∫—É–±–∏–∫"></div>


<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="dice-modal">
  <div id="dice-modal-content">
    <button id="close-modal" title="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
    <h3>–í—ã–±–µ—Ä–∏ –∫—É–±–∏–∫</h3>
    <div>
      <div class="dice-option" onclick="rollDice(4)">d4</div>
      <div class="dice-option" onclick="rollDice(6)">d6</div>
      <div class="dice-option" onclick="rollDice(8)">d8</div>
      <div class="dice-option" onclick="rollDice(10)">d10</div>
      <div class="dice-option" onclick="rollDice(12)">d12</div>
      <div class="dice-option" onclick="rollDice(20)">d20</div>
      <div class="dice-option" onclick="rollDice(6, 2)">2d6</div>
    </div>
    <div id="dice-animation" class="dice-animation" style="display: none;"></div>
    <div id="dice-result" class="dice-result"></div>
    <div id="dice-history" class="dice-history"></div>
    <button id="clear-history-btn">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
  </div>
</div>

<div class="section">
  <h2>–í–Ω–µ—à–Ω–æ—Å—Ç—å</h2>
  <p contenteditable="true" id="appearance" style="min-height: 60px;">–û–ø–∏—à–∏ –≤–Ω–µ—à–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞...</p>
</div>

<div class="section">
  <h2>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h2>
  <div class="flex-row">
    <div class="attribute">
      <div class="label">–°–∏–ª–∞</div>
      <div contenteditable="true" oninput="updateModifiers()" id="str">10</div>
      <div class="modifier" id="mod-str">–ë–æ–Ω—É—Å –∫ –±—Ä–æ—Å–∫—É: +0</div>
    </div>
    <div class="attribute">
      <div class="label">–õ–æ–≤–∫–æ—Å—Ç—å</div>
      <div contenteditable="true" oninput="updateModifiers()" id="dex">10</div>
      <div class="modifier" id="mod-dex">–ë–æ–Ω—É—Å –∫ –±—Ä–æ—Å–∫—É: +0</div>
    </div>
  </div>
  <div class="flex-row">
    <div class="attribute">
      <div class="label">–¢–µ–ª–æ—Å–ª–æ–∂–µ–Ω–∏–µ</div>
      <div contenteditable="true" oninput="updateModifiers()" id="con">10</div>
      <div class="modifier" id="mod-con">–ë–æ–Ω—É—Å –∫ –±—Ä–æ—Å–∫—É: +0</div>
    </div>
    <div class="attribute">
      <div class="label">–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç</div>
      <div contenteditable="true" oninput="updateModifiers()" id="int">10</div>
      <div class="modifier" id="mod-int">–ë–æ–Ω—É—Å –∫ –±—Ä–æ—Å–∫—É: +0</div>
    </div>
  </div>
  <div class="flex-row">
    <div class="attribute">
      <div class="label">–ú—É–¥—Ä–æ—Å—Ç—å</div>
      <div contenteditable="true" oninput="updateModifiers()" id="wis">10</div>
      <div class="modifier" id="mod-wis">–ë–æ–Ω—É—Å –∫ –±—Ä–æ—Å–∫—É: +0</div>
    </div>
    <div class="attribute">
      <div class="label">–•–∞—Ä–∏–∑–º–∞</div>
      <div contenteditable="true" oninput="updateModifiers()" id="cha">10</div>
      <div class="modifier" id="mod-cha">–ë–æ–Ω—É—Å –∫ –±—Ä–æ—Å–∫—É: +0</div>
    </div>
  </div>
</div>


<div class="section flex-row">
  <div class="stat">
    <div class="label"><span class="icon">üé≤</span>–£—Ä–æ–Ω</div>
    <div contenteditable="true" id="damage">1d6</div>
  </div>
  <div class="stat">
    <div class="label"><span class="icon">üõ°Ô∏è</span>–ë—Ä–æ–Ω—è</div>
    <div contenteditable="true" id="armor">12</div>
  </div>
  <div class="stat">
    <div class="label"><span class="icon">‚ù§Ô∏è</span>–û–±—â–µ–µ –∑–¥–æ—Ä–æ–≤—å–µ</div>
    <div contenteditable="true" id="hp">30</div>
  </div>
</div>

<div class="section flex-row">
  <div class="stat" style="flex: 2 1 300px;">
    <div class="label">–ú–∏—Ä–æ–≤–æ–∑–∑—Ä–µ–Ω–∏–µ</div>
    <div contenteditable="true" id="alignment">–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –∑–ª–æ–µ</div>
  </div>
  <div class="stat">
    <div class="label">–†–∞—Å–∞</div>
    <div contenteditable="true" id="race">–ß–µ–ª–æ–≤–µ–∫</div>
  </div>
  <div class="stat" style="flex: 2 1 300px;">
    <div class="label">–£–∑—ã</div>
    <div contenteditable="true" id="bonds">–°–≤—è–∑—å —Å —Ç–µ–Ω—è–º–∏</div>
  </div>
</div>

<div class="section">
  <h2>–°—Ç–∞—Ä—Ç–æ–≤—ã–µ —Ö–æ–¥—ã</h2>
  <ul id="moves-list">
    <li>
      <div class="move-title" contenteditable="true">–¢–µ–º–Ω–æ–µ –ø—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–∏–µ</div>
      <div class="move-text" contenteditable="true">–¢–≤–æ–∏ –∞—Ç–∞–∫–∏ –Ω–∞–Ω–æ—Å—è—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —É—Ä–æ–Ω —Ç—å–º–æ–π.</div>
    </li>
  </ul>
  <button id="add-move-btn">–î–æ–±–∞–≤–∏—Ç—å —Ö–æ–¥</button>
</div>

<div class="section flex-row">
  <div class="stat" style="flex: 1 1 150px;">
    <div class="label">–ö–ª–∞—Å—Å</div>
    <div contenteditable="true" id="class">–í–∞—Ä–≤–∞—Ä</div>
  </div>
  <div class="stat" style="flex: 1 1 150px;">
    <div class="label">–£—Ä–æ–≤–µ–Ω—å</div>
    <div contenteditable="true" id="level">1</div>
  </div>
  <div class="stat" style="flex: 1 1 150px;">
    <div class="label">–û–ø—ã—Ç</div>
    <div contenteditable="true" id="xp">0</div>
  </div>
</div>

<div class="section">
  <h2>–°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ</h2>
  <p contenteditable="true" id="gear" style="min-height: 60px;">–ö–∏–Ω–∂–∞–ª, –ú–∞–Ω—Ç–∏—è –∏–∑ —Ç–µ–Ω–µ–π, –§–ª—è–≥–∞ —Å —è–¥–æ–º</p>
</div>

<div class="section">
  <h2>–†–∞—Å–æ–≤–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å</h2>
  <p contenteditable="true" id="racial-ability" style="min-height: 40px;">–¢–µ–º–Ω–æ–µ –∑—Ä–µ–Ω–∏–µ</p>
</div>

<div class="section">
  <h2>–ü—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—è</h2>
  <p contenteditable="true" id="backstory" style="min-height: 80px;">–†–∞—Å—Å–∫–∞–∑ –æ –º—Ä–∞—á–Ω–æ–º –ø—Ä–æ—à–ª–æ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞...</p>
</div>

<div class="section">
  <h2>–ó–∞–º–µ—Ç–∫–∏</h2>
  <p contenteditable="true" id="notes" style="min-height: 80px;">–ú–æ–∂–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂ –ª—é–±–∏—Ç –ø–∏–≤–æ...</p>
</div>

<div class="section">
  <button onclick="saveToFile()">üì• –°–∫–∞—á–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
  <button onclick="loadFromFile()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
  <button onclick="sendToBot()" id="send-to-bot-btn">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –±–æ—Ç–∞</button>
  <button onclick="loadFromBot()" id="load-from-bot-btn">üì° –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –±–æ—Ç–∞</button>
</div>

<script>
  const modal = document.getElementById('dice-modal');
  const openBtn = document.getElementById('dice-button');
  const closeBtn = document.getElementById('close-modal');
  const animation = document.getElementById('dice-animation');
  const resultBox = document.getElementById('dice-result');
  const historyBox = document.getElementById('dice-history');
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑ localStorage –∏–ª–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
  let diceHistory = JSON.parse(localStorage.getItem('diceHistory')) || [];
  diceHistory = diceHistory.filter(entry => 
    typeof entry === 'string' && entry.trim().toLowerCase().startsWith('–±—Ä–æ—Å–æ–∫')
    );
  let xp = parseInt(localStorage.getItem('xp')) || 0;
  document.getElementById('xp').textContent = xp;
  document.getElementById('xp').addEventListener('input', function () {
  const newVal = parseInt(this.textContent);
  if (!isNaN(newVal)) {
    xp = newVal;
    localStorage.setItem('xp', xp);
  }
  });
  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –≤ –æ–∫–Ω–µ
  function renderHistory() {
    historyBox.innerHTML = '';
    let lastFive = diceHistory.slice().reverse();
    lastFive.forEach(entry => {
      const div = document.createElement('div');
      div.textContent = entry;
      historyBox.appendChild(div);
    });
  }

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –≤ localStorage
  function saveHistory() {
    localStorage.setItem('diceHistory', JSON.stringify(diceHistory));
  }

  openBtn.onclick = () => {
    modal.style.display = 'flex';
    resultBox.textContent = '';
    renderHistory();
  };

  closeBtn.onclick = () => {
    modal.style.display = 'none';
    animation.style.display = 'none';
  };
  document.getElementById('clear-history-btn').addEventListener('click', () => {
  diceHistory = [];
  saveHistory();
  renderHistory();
  });
  document.getElementById('clear-history-btn').addEventListener('click', () => {
  // –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –±—Ä–æ—Å–∫–æ–≤
  diceHistory = [];
  saveHistory();
  renderHistory();

  // –û–±–Ω—É–ª–µ–Ω–∏–µ –æ–ø—ã—Ç–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
  xp = 0;
  localStorage.setItem('xp', xp);
  document.getElementById('xp').textContent = xp;
  });
  function rollDice(sides, count = 1) {
    resultBox.textContent = '';
    animation.style.display = 'block';

    setTimeout(() => {
      animation.style.display = 'none';

      let rolls = [];
      for (let i = 0; i < count; i++) {
        rolls.push(Math.floor(Math.random() * sides) + 1);
      }

      const total = rolls.reduce((sum, r) => sum + r, 0);
      let resultText = "";

      if (count === 1) {
        resultText = `–ë—Ä–æ—Å–æ–∫ = ${rolls[0]}`;
      } else {
        resultText = `–ë—Ä–æ—Å–æ–∫ ${rolls.join(' + ')} = ${total}`;
      }
      
      const percent = (total / (sides * count)) * 100;

      if (percent < 58) {
      resultBox.style.color = 'red';
      } else if (percent >= 58 && percent <= 75) {
      resultBox.style.color = 'orange';
      } else {
      resultBox.style.color = 'green';
      }

      resultBox.textContent = resultText;

      // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
      diceHistory.push(resultText);
      xp += 1;
      localStorage.setItem('xp', xp);
      document.getElementById('xp').textContent = xp;

      diceHistory = diceHistory.filter(entry => 
      typeof entry === 'string' && entry.trim().toLowerCase().startsWith('–±—Ä–æ—Å–æ–∫')
      );
      if (diceHistory.length > 100) {
      diceHistory = diceHistory.slice(diceHistory.length - 100);
      }
      saveHistory();
      renderHistory();
    }, 2000);
  }

 function getModifier(value) {
  value = parseInt(value);
  if (isNaN(value)) return 0;
  if (value < 9) return -1;
  if (value <= 12) return 0;
  if (value <= 15) return 1;
  if (value <= 19) return 2;
  if (value >= 20) return 3;
  return 0;
}

function updateModifiers() {
  const ids = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
  ids.forEach(id => {
    let val = parseInt(document.getElementById(id).innerText);
    if (isNaN(val)) val = 10;
    const mod = getModifier(val);
    const modEl = document.getElementById('mod-' + id);
    modEl.innerText = '–ë–æ–Ω—É—Å –∫ –±—Ä–æ—Å–∫—É: ' + (mod >= 0 ? '+' : '') + mod;
    if (mod < 0) {
      modEl.style.color = '#e06c75'; // –∫—Ä–∞—Å–Ω—ã–π
    } else if (mod === 0) {
      modEl.style.color = '#aaa'; // —Å–µ—Ä—ã–π
    } else {
      modEl.style.color = '#98c379'; // –∑–µ–ª—ë–Ω—ã–π
    }
  });
}

function getContent() {
  return {
    name: document.getElementById('character-name').textContent,
    appearance: document.getElementById('appearance').textContent,
    damage: document.getElementById('damage').textContent,
    armor: document.getElementById('armor').textContent,
    hp: document.getElementById('hp').textContent,
    alignment: document.getElementById('alignment').textContent,
    race: document.getElementById('race').textContent,
    bonds: document.getElementById('bonds').textContent,
    gear: document.getElementById('gear').textContent,
    class: document.getElementById('class').textContent,
    level: document.getElementById('level').textContent,
    xp: document.getElementById('xp').textContent,
    racialAbility: document.getElementById('racial-ability').textContent,
    backstory: document.getElementById('backstory').textContent,
    notes: document.getElementById('notes').textContent,
    attributes: ['str','dex','con','int','wis','cha'].map(id => ({
      name: document.querySelector(`[for="${id}"]`)?.textContent || id,
      value: document.getElementById(id).textContent
    })),
    moves: [...document.querySelectorAll('#moves-list li')].map(li => ({
      title: li.querySelector('.move-title').textContent,
      text: li.querySelector('.move-text').textContent
    }))
  };
}



function saveToFile() {
  const blob = new Blob([JSON.stringify(getContent(), null, 2)], { type: 'application/json' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'character.json';
  link.click();
}

function loadFromFile() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      const data = JSON.parse(reader.result);
      if (data.name) document.getElementById('character-name').textContent = data.name;
      document.getElementById('appearance').textContent = data.appearance || '';
      document.getElementById('damage').textContent = data.damage || '';
      document.getElementById('armor').textContent = data.armor || '';
      document.getElementById('hp').textContent = data.hp || '';
      document.getElementById('alignment').textContent = data.alignment || '';
      document.getElementById('race').textContent = data.race || '';
      document.getElementById('bonds').textContent = data.bonds || '';
      document.getElementById('gear').textContent = data.gear || '';
      document.getElementById('class').textContent = data.class || '';
      document.getElementById('level').textContent = data.level || '';
      document.getElementById('xp').textContent = data.xp || '';
      document.getElementById('racial-ability').textContent = data.racialAbility || '';
      document.getElementById('backstory').textContent = data.backstory || '';
      document.getElementById('notes').textContent = data.notes || '';
      ['str','dex','con','int','wis','cha'].forEach((id, i) => {
        if(data.attributes && data.attributes[i]) {
          document.getElementById(id).textContent = data.attributes[i].value;
        }
      });
      updateModifiers();
      const movesList = document.getElementById('moves-list');
      movesList.innerHTML = '';
      if (data.moves && data.moves.length) {
        data.moves.forEach(move => {
          const li = document.createElement('li');
          li.innerHTML = `
            <div class="move-title" contenteditable="true">${move.title}</div>
            <div class="move-text" contenteditable="true">${move.text}</div>
          `;
          movesList.appendChild(li);
        });
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

window.addEventListener('load', () => {
  updateModifiers();
});
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–æ—Ä–º—ã –≤ localStorage
function autosave() {
  const data = {};

  document.querySelectorAll('[contenteditable="true"]').forEach(el => {
    if (el.id) {
      data[el.id] = el.innerText;
    }
  });
  const moves = [...document.querySelectorAll('#moves-list li')].map(li => ({
    title: li.querySelector('.move-title')?.textContent.trim() || '',
    text: li.querySelector('.move-text')?.textContent.trim() || ''
  }));
  data.moves = moves;
  const notif = document.getElementById('save-notification');
  notif.style.opacity = 1;
  setTimeout(() => notif.style.opacity = 0, 1500);

  localStorage.setItem('autosaveData', JSON.stringify(data));
  console.log('–î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
}

const TELEGRAM_USER_ID = '529193051';

// –ê–¥—Ä–µ—Å backend —Å–µ—Ä–≤–µ—Ä–∞ (–≥–¥–µ –∑–∞–ø—É—â–µ–Ω –±–æ—Ç –∏–ª–∏ –ø—Ä–æ–∫—Å–∏ API)
const BACKEND_URL = 'https://dndbot-ejj9.onrender.com';

async function saveCharacter(userId, characterName, characterData) {
  const response = await fetch("https://dndbot-ejj9.onrender.com/save_character", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      user_id: userId,
      character_name: characterName,
      character: characterData
    })
  });
  const result = await response.json();
  console.log(result.message);
}

async function loadCharacter(userId, characterName) {
  try {
    const response = await fetch(`https://dndbot-ejj9.onrender.com/load_character?user_id=${userId}&character_name=${encodeURIComponent(characterName)}`);
    if (!response.ok) throw new Error("Character not found");
    const data = await response.json();
    console.log(data.character);
    return data.character;
  } catch (e) {
    console.error(e);
  }
}

// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–±–æ—Ç—É)
async function sendToBot() {
  const data = getContent();
  try {
    const response = await fetch(`${BACKEND_URL}/save_character`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        user_id: parseInt(TELEGRAM_USER_ID), 
        character_name: data.name,           
        character: data
      })
    });

    if (response.ok) {
      localStorage.setItem("lastCharacterName", data.name);
      alert('–ü–µ—Ä—Å–æ–Ω–∞–∂ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç—É —É—Å–ø–µ—à–Ω–æ!');
    } else {
      const error = await response.json();
      alert(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: ${error.detail}`);
      console.error(error);
    }
  } catch (e) {
    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞.');
    console.error(e);
  }
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞ (–±–æ—Ç–∞)
async function loadFromBot() {
  try {
  const characterName = localStorage.getItem("lastCharacterName") || prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:");

    const response = await fetch(`${BACKEND_URL}/load_character?user_id=${TELEGRAM_USER_ID}&character_name=${encodeURIComponent(characterName)}`);
    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');

    const result = await response.json();
    const data = result.character;
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –∏–∑ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ JSON
    if (data) {
      if (data.name) document.getElementById('character-name').textContent = data.name;
      document.getElementById('appearance').textContent = data.appearance || '';
      document.getElementById('damage').textContent = data.damage || '';
      document.getElementById('armor').textContent = data.armor || '';
      document.getElementById('hp').textContent = data.hp || '';
      document.getElementById('alignment').textContent = data.alignment || '';
      document.getElementById('race').textContent = data.race || '';
      document.getElementById('bonds').textContent = data.bonds || '';
      document.getElementById('gear').textContent = data.gear || '';
      document.getElementById('class').textContent = data.class || '';
      document.getElementById('level').textContent = data.level || '';
      document.getElementById('xp').textContent = data.xp || '';
      document.getElementById('racial-ability').textContent = data.racialAbility || '';
      document.getElementById('backstory').textContent = data.backstory || '';
      document.getElementById('notes').textContent = data.notes || '';
      ['str','dex','con','int','wis','cha'].forEach((id, i) => {
        if(data.attributes && data.attributes[i]) {
          document.getElementById(id).textContent = data.attributes[i].value;
        }
      });
      updateModifiers();
      const movesList = document.getElementById('moves-list');
      movesList.innerHTML = '';
      if (data.moves && data.moves.length) {
        data.moves.forEach(move => {
          const li = document.createElement('li');
          li.innerHTML = `
            <div class="move-title" contenteditable="true">${move.title}</div>
            <div class="move-text" contenteditable="true">${move.text}</div>
          `;
          movesList.appendChild(li);
        });
      }
      alert('–ü–µ—Ä—Å–æ–Ω–∞–∂ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –±–æ—Ç–∞!');
    }
  } catch (e) {
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏–∑ –±–æ—Ç–∞.');
    console.error(e);
  }
}

function setupMovesListeners() {
  const movesList = document.getElementById('moves-list');
  if (!movesList) return;

  movesList.querySelectorAll('[contenteditable="true"]').forEach(el => {
    el.addEventListener('input', autosave);
  });
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º contenteditable –¥–∞–Ω–Ω—ã–µ
function autoload() {
  const savedData = localStorage.getItem('autosaveData');
  if (!savedData) return;

  const data = JSON.parse(savedData);
  Object.entries(data).forEach(([key, value]) => {
    const el = document.getElementById(key);
    if (el && el.hasAttribute('contenteditable')) {
      el.innerText = value;
    }
  });
  if (data.moves && Array.isArray(data.moves)) {
    const movesList = document.getElementById('moves-list');
    if (movesList) {
      movesList.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫
      data.moves.forEach(move => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="move-title" contenteditable="true">${move.title || ''}</div>
          <div class="move-text" contenteditable="true">${move.text || ''}</div>
        `;
        movesList.appendChild(li);
      });
    }
  }
  setupMovesListeners()
  updateModifiers(); // –æ–±–Ω–æ–≤–ª—è–µ–º –±–æ–Ω—É—Å—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
  console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
}

window.addEventListener('DOMContentLoaded', () => {
  autoload();

  document.querySelectorAll('[contenteditable="true"]').forEach(el => {
    el.addEventListener('input', autosave);
  });
});
document.getElementById('add-move-btn').addEventListener('click', () => {
  const movesList = document.getElementById('moves-list');
  const li = document.createElement('li');
  li.innerHTML = `
    <div class="move-title" contenteditable="true">–ù–æ–≤—ã–π —Ö–æ–¥</div>
    <div class="move-text" contenteditable="true">–û–ø–∏—Å–∞–Ω–∏–µ —Ö–æ–¥–∞...</div>
  `;
  movesList.appendChild(li);
   li.querySelectorAll('[contenteditable="true"]').forEach(el => {
    el.addEventListener('input', autosave);
  });
  autosave();
});

</script>

<div id="save-notification" style="
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: #b34e2dcc;
  color: white;
  padding: 6px 12px;
  border-radius: 4px;
  font-size: 0.9em;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.5s ease;
  z-index: 9999;
">
  –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ
</div>

</body>
</html>
